services:
  # Python RAG application (run with: docker compose run app <command>)
  app:
    build: .
    container_name: rag-app
    environment:
      MONGO_DB_URL: mongodb://mongo:27017
      # host.docker.internal = host machine (where Ollama runs natively)
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_MODEL: nomic-embed-text
      OLLAMA_LLM_MODEL: llama3.2
      # LangFuse v3 configuration - set keys in .env after creating account at http://localhost:3000
      LANGFUSE_HOST: http://langfuse-web:3000
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY}
    depends_on:
      - mongo
      - langfuse-web
    volumes:
      # Mount product docs so you can update without rebuilding
      - ./product-documentation:/app/product-documentation:ro
    profiles:
      - cli # Only runs when explicitly called

  # MongoDB Atlas Local (includes vector search support)
  # No volume = fresh state every restart (avoids keyfile corruption issues)
  mongo:
    image: mongodb/mongodb-atlas-local:8
    container_name: rag-mongo
    ports:
      - "27017:27017"

  # ===================
  # LangFuse v3 Stack
  # ===================

  langfuse-web:
    image: langfuse/langfuse:3
    container_name: rag-langfuse-web
    restart: always
    depends_on:
      langfuse-postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment: &langfuse-env
      DATABASE_URL: postgresql://langfuse:langfuse@langfuse-postgres:5432/langfuse
      NEXTAUTH_SECRET: my-nextauth-secret-change-in-production
      NEXTAUTH_URL: http://localhost:3000
      SALT: my-salt-change-in-production
      ENCRYPTION_KEY: "0000000000000000000000000000000000000000000000000000000000000000"
      TELEMETRY_ENABLED: "false"
      # ClickHouse
      CLICKHOUSE_MIGRATION_URL: clickhouse://clickhouse:9000
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_USER: clickhouse
      CLICKHOUSE_PASSWORD: clickhouse
      CLICKHOUSE_CLUSTER_ENABLED: "false"
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_AUTH: myredissecret
      # MinIO (S3-compatible storage)
      LANGFUSE_S3_EVENT_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_EVENT_UPLOAD_REGION: auto
      LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: minio
      LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: miniosecret
      LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: http://minio:9000
      LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: "true"
      LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_MEDIA_UPLOAD_REGION: auto
      LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: minio
      LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: miniosecret
      LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: http://minio:9000
      LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: "true"

  langfuse-worker:
    image: langfuse/langfuse-worker:3
    container_name: rag-langfuse-worker
    restart: always
    depends_on:
      langfuse-postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    environment:
      <<: *langfuse-env

  langfuse-postgres:
    image: postgres:17
    container_name: rag-langfuse-db
    restart: always
    environment:
      POSTGRES_USER: langfuse
      POSTGRES_PASSWORD: langfuse
      POSTGRES_DB: langfuse
    volumes:
      - langfuse_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse"]
      interval: 3s
      timeout: 3s
      retries: 10

  clickhouse:
    image: clickhouse/clickhouse-server
    container_name: rag-langfuse-clickhouse
    restart: always
    user: "101:101"
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: clickhouse
      CLICKHOUSE_PASSWORD: clickhouse
    volumes:
      - langfuse_clickhouse_data:/var/lib/clickhouse
      - langfuse_clickhouse_logs:/var/log/clickhouse-server
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 1s

  minio:
    image: minio/minio
    container_name: rag-langfuse-minio
    restart: always
    command: server --address ":9000" --console-address ":9001" /data
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: miniosecret
    volumes:
      - langfuse_minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 1s

  # Create the langfuse bucket on startup
  minio-init:
    image: minio/mc
    container_name: rag-langfuse-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minio miniosecret;
      mc mb myminio/langfuse --ignore-existing;
      exit 0;
      "

  redis:
    image: redis:7
    container_name: rag-langfuse-redis
    restart: always
    command: >
      --requirepass myredissecret
      --maxmemory-policy noeviction
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "myredissecret", "ping"]
      interval: 3s
      timeout: 10s
      retries: 10

volumes:
  langfuse_postgres_data:
  langfuse_clickhouse_data:
  langfuse_clickhouse_logs:
  langfuse_minio_data:
